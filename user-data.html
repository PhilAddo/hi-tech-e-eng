<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <title>User Data</title>
</head>

<body style="display: none;">
  <input type="button" value="Sign Out" onclick="signOut();">
  <h2>User Data</h2>

  <ul id="user-list"></ul>

  <p id="message"></p>

  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const supabaseUrl = "https://xcgzdeupoteayfiorscj.supabase.co";
    const supabaseKey = "sb_publishable_2B60fPIaI1PiLYcvCfgGYA_KveaLaEv";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    async function protectPage() {
      const { data: { user } } =
        await supabaseClient.auth.getUser();

      if (!user) {
        window.location.href = "sign-in.html";
        return;
      }

      const { data, error } = await supabaseClient
        .from("allowed_emails")
        .select("email")
        .eq("email", user.email)
        .single();

      if (error || !data) {
        alert("Access denied");
        await supabaseClient.auth.signOut();
        window.location.href = "sign-in.html";
      }
      //makes the content of the page visible
      document.body.style.display = "block";
      fetchUsers();
    }

    protectPage();


    const message = document.getElementById("message");
    let userCount = 0;

    async function fetchUsers() {
      const { data, error } = await supabaseClient
        .from("customerRequests")
        .select("id, full_name, location, phone_number, service, created_at")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Error fetching users:", error.message);
        message.innerHTML = "Error fetching users.";
        return;
      }

      const userList = document.getElementById("user-list");
      userList.innerHTML = "";

      data.forEach((user) => {
        const li = `<li onclick="showUserDetails('${user.id}');">${user.full_name} (${user.location}) - ${user.created_at}</li>`;
        userList.innerHTML += li;

        userCount++;
      });
      message.innerHTML = `Count: ${userCount}`;
    }

    async function showUserDetails(id) {
      const { data, error } = await supabaseClient
        .from("customerRequests")
        .select("*")
        .eq("id", id)
        .single();

      alert(`Name: ${data.full_name}\nLocation: ${data.location}\nPhone Number: ${data.phone_number}\nService: ${data.service}`)
    }

    //signs user out
    async function signOut() {
      await supabaseClient.auth.signOut();
      window.location.href = "sign-in.html";
    }
  </script>
</body>

</html>