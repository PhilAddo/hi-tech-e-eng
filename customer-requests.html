<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer Requests</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body style="display: none;">

    <!-- Header -->
    <header>
        <div class="container">
            <h1>HI-Tech E. Eng Services</h1>
            <nav id="nav1">
                <a href="index.html">Home</a>
                <a href="index.html#services">Services</a>
                <a href="index.html#about">About</a>
                <a href="index.html#request">Request Service</a>
                <a href="#contact">Contact</a>
                <a href="#" onclick="signOut()">Sign Out</a>
            </nav>
            <span id="menu-icon">
                ‚ò∞
            </span>
        </div>
        <nav id="nav2">
            <a href="index.html">Home</a>
            <a href="index.html#services">Services</a>
            <a href="index.html#about">About</a>
            <a href="index.html#request">Request Service</a>
            <a href="#contact">Contact</a>
            <a href="#" onclick="signOut()">Sign Out</a>
        </nav>
    </header>

    <!-- customer request list -->
    <div id="request-table-container" class="section">
        <h2>Customer Requests</h2>
        <i>Click on a request to view details</i><br><br>
        <p id="message">Requests: <b>0</b></p>
        <table id="customer-list-table">
            <tr>
                <th>Name</th>
                <th>Service Requested</th>
                <th>Time Submitted</th>
            </tr>
            <tr>
             <td colspan="3">Fetching requests...</td>
            </tr>
        </table>
    </div>

    <!-- customer request details -->
    <div id="request-details-container" class="section" style="display: none;">
        <div class="container">
            <h2>Request Details</h2>
            <span id="close-request-details-icon">‚úñ</span>
        </div>

        <table id="request-details-table">
            <tr>
                <td><b>Full Name</b></td>
                <td>John Doe</td>
            </tr>
            <tr>
                <td><b>Phone Number</b></td>
                <td>0547144715</td>
            </tr>
            <tr>
                <td><b>Email Address</b></td>
                <td>boyephilip7@gmail.com</td>
            </tr>
            <tr>
                <td><b>Requested Service</b></td>
                <td>Power Installation</td>
            </tr>
            <tr>
                <td><b>Location</b></td>
                <td>Tema</td>
            </tr>
            <tr>
                <td><b>Request Description</b></td>
                <td>Sample customer request description for Power Installation service request.
                </td>
            </tr>
        </table>
    </div>


    <!-- Contact -->
    <footer id="contact">
        <p><i style="font-family: cursive;">Excellence in every Ampere.</i></p>
        <p>üìû +233 54 000 0000 | ‚úâÔ∏è info@htees.com</p>
        <p>¬© 2026 HI-Tech E. Eng Services. All Rights Reserved.</p>
    </footer>

</body>
<!-- Supabase JS CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="script.js"></script>
<script>
    const msg = document.getElementById("message");
    const requestTableContainer = document.getElementById("request-table-container");
    const requestDetailsContainer = document.getElementById("request-details-container");
    const closeRequestDetailsIcon = document.getElementById("close-request-details-icon");
    const customerListTable = document.getElementById("customer-list-table");
    const requestDetailstable = document.getElementById("request-details-table");

    //selects the close request details icon
    closeRequestDetailsIcon.addEventListener("click", () => {
        requestTableContainer.style.display = "block";
        requestDetailsContainer.style.display = "none";
    });

    //checks if user is logged in and is authorized to view page
    async function protectPage() {
        const { data: { user } } =
            await supabaseClient.auth.getUser();

        if (!user) {
            window.location.href = "sign-in.html";
            return;
        }

        const { data, error } = await supabaseClient
            .from("allowed_emails")
            .select("email")
            .eq("email", user.email)
            .single();

        if (error || !data) {
            alert("Access denied");
            await supabaseClient.auth.signOut();
            window.location.href = "sign-in.html";
        }
        //makes the content of the page visible
        document.body.style.display = "block";
        fetchRequests();
    }

    protectPage();


    const message = document.getElementById("message");
    let requestCount = 0;

    async function fetchRequests() {
        const { data, error } = await supabaseClient
            .from("customerRequests")
            .select("id, full_name, service, created_at")
            .order("created_at", { ascending: false });

        if (error) {
            console.error("Error fetching users:", error.message);
            message.innerHTML = "Error fetching users.";
            return;
        }

        customerListTable.innerHTML = `
            <tr>
                <th>Name</th>
                <th>Requested Service</th>
                <th>Time Submitted</th>
            </tr>
      `;

        data.forEach((user) => {
        const time = getTimeAndDate(user.created_at);
            const tr = `
        <tr onclick="showRequestDetails('${user.id}');">
            <td>${user.full_name}</td>
            <td>${user.service}</td>
            <td>${time}</td>
        </tr>
        `;
            customerListTable.innerHTML += tr;

            requestCount++;
        });
        message.innerHTML = `Requests: <b>${requestCount}</b>`;
    }

    function getTimeAndDate(val){
        let arr = val.split(".");
        return arr[0];
    }

    async function showRequestDetails(id) {
        const { data, error } = await supabaseClient
            .from("customerRequests")
            .select("*")
            .eq("id", id)
            .single();

        requestDetailsContainer.style.display = "block";
        requestTableContainer.style.display = "none";
        requestDetailstable.innerHTML = `
            <tr>
                <td><b>Full Name</b></td>
                <td>${data.full_name}</td>
            </tr>
            <tr>
                <td><b>Phone Number</b></td>
                <td>${data.phone_number}</td>
            </tr>
            <tr>
                <td><b>Email Address</b></td>
                <td>${data.email_address}</td>
            </tr>
            <tr>
                <td><b>Requested Service</b></td>
                <td>${data.service}</td>
            </tr>
            <tr>
                <td><b>Location</b></td>
                <td>${data.location}</td>
            </tr>
            <tr>
                <td><b>Request Description</b></td>
                <td>${data.description}</td>
            </tr>
        `;
    }

    //signs user out
    async function signOut() {
        await supabaseClient.auth.signOut();
        window.location.href = "sign-in.html";
    }

</script>

</html>